var iWantedWindow=require('ui/common/iWantedWindow');
function iWantedListWindow(title){
	var self=new iWantedWindow(title);

	var indicator=Ti.UI.createActivityIndicator({
		style: Titanium.UI.iPhone.ActivityIndicatorStyle.PLAIN,
		font : {fontFamily:'Helvetica Neue', fontSize:15,fontWeight:'bold'},
		color:'white',
		message : 'Loading...'
	});
	self.setToolbar([indicator],{animated:true});
	//self.add(indicator);
	indicator.show();
	var xhr = Titanium.Network.createHTTPClient();
		xhr.onload = function()
		{
			indicator.hide();
			
			var wanteds= JSON.parse( this.responseText);
			var ids=[];
			var userId=[];
			for(var wanted in wanteds){
				ids.push(" url='http://tw.iwanted.jit.su/wanted/"+wanteds[wanted].id+"' ");
				userId.push(' uid='+wanteds[wanted].id);
				Ti.API.log(wanteds[wanted].title);
					
			}
			var query="SELECT comments_fbid,url,like_count,commentsbox_count FROM link_stat WHERE "+ids.join(' or ');
			var query2="SELECT name, sex, pic_small,birthday FROM user WHERE "+userId.join(' or ');
			Ti.API.info(query);
			Ti.API.info(query2);
			
	
			Ti.Facebook.request('fql.query', {query: query},  function(r)
			{
				if (r.success) {
					
					
					
				Ti.Facebook.request('fql.query', {query: query2},  function(k)
				{
				
					Ti.API.log(k.result);
					var results=JSON.parse(r.result);
					for(var wanted in wanteds){
						for(var result in results){
							if(("http://tw.iwanted.jit.su/wanted/"+wanteds[wanted].id)==results[result].url){
								wanteds[wanted].like_count=results[result].like_count;
								wanteds[wanted].comment_count=results[result].commentsbox_count;	
							}	
						}
						if(wanteds[wanted].like_count==undefined){
							wanteds[wanted].like_count=0;
							wanteds[wanted].comment_count=0;
						}
						Ti.UI.createTableViewRow();
					}
				});
					
					
					
				}	
				Ti.API.info(r);	
			});
			
		};
		xhr.onerror = function()
		{
			Titanium.API.info('error');
		};
		xhr.open("GET","http://tw.iwanted.jit.su/api/wanted");
		xhr.send();
	//Ti.Facebook.request()
	
	
	return self;
	
	
	
}
module.exports = iWantedListWindow;
